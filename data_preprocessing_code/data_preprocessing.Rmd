This tutorial illustrates how to export expression matrices and cell type labels from SingleCellExperiment objects to 5-fold cross-validation .h5 file as input for Matilda.
The dataset is downloaded via 
http://
Here, we show the process of one CITE-seq data, one SHARE-seq data and one TEA-seq data.


## Load package
```{r}
library(scran)
library(caret)
library(glue)
source("data_to_h5.R")
```

##choose the dataset to process
```{r}
dataset_name = "Ma et al. (GSE140203)"
dataset_name = "Swanson et al. (GSE158013)"
#dataset_name = "Ramaswamy et al. (GSE166489)"
```

## Load real datasets and process for SHARE-seq data
```{r}
if (dataset_name == "Ma et al. (GSE140203)"){
  ###########  load rna and atac, then filt them to 99%  ###########
  sceRNA <- readRDS("../data/Ma et al. (GSE140203)/rna.rds")
  sceATAC <- readRDS( "../data/Ma et al. (GSE140203)/atac.rds")
  
  sel <- names(which(rowSums(logcounts(sceRNA) == 0) / ncol(logcounts(sceRNA)) < 0.99))
  sceRNA <- sceRNA[sel,]
  sel <- names(which(rowSums(logcounts(sceATAC) == 0) / ncol(logcounts(sceATAC)) < 0.99))
  sceATAC <- sceATAC[sel,]
  
  ###########filter the cell type whose number is less than 10###########
  rna.filt <- as.matrix(logcounts(sceRNA))
  atac.filt <- as.matrix(logcounts(sceATAC))
  cty <- factor(sceRNA$celltype)

  rna.filt <- rna.filt[, cty %in% names(table(cty))[table(cty)>10]]
  atac.filt <- atac.filt[, cty %in% names(table(cty))[table(cty)>10]]
  cty <- cty[cty %in% names(table(cty))[table(cty)>10]]
  cty <- as.character(cty)
  
  ################## z-score normalization ##################
  mean_rna <- colMeans(rna.filt)
  sd_rna <- colSds(rna.filt)
  mean_rna<-c(rep(mean_rna,dim(rna.filt)[1]))
  mean_rna <-t(matrix(mean_rna, nrow=dim(rna.filt)[2]))
  sd_rna<-c(rep(sd_rna,dim(rna.filt)[1]))
  sd_rna <-t(matrix(sd_rna, nrow=dim(rna.filt)[2]))
  rna.filt <- (rna.filt - mean_rna)/sd_rna
  
  mean_atac <- colMeans(atac.filt)
  sd_atac <- colSds(atac.filt)
  mean_atac<-c(rep(mean_atac,dim(atac.filt)[1]))
  mean_atac <-t(matrix(mean_atac, nrow=dim(atac.filt)[2]))
  sd_atac<-c(rep(sd_atac,dim(atac.filt)[1]))
  sd_atac <-t(matrix(sd_atac, nrow=dim(atac.filt)[2]))
  atac.filt <- (atac.filt - mean_atac)/sd_atac
}  
```

## Load real datasets and process for TEA-seq data
```{r}
if (dataset_name == "Swanson et al. (GSE158013)"){
  ###########  load rna adt, and atac, then filt them to 99%  ###########
  sce_control <- readRDS("./../data/Swanson et al. (GSE158013)/batch1.rds")
  
  sel <- names(which(rowSums(logcounts(sce_control) == 0) / ncol(logcounts(sce_control)) < 0.99))
  sce_control <- sce_control[sel,]
  rna.filt <- as.matrix(logcounts(sce_control))
  adt.filt <- as.matrix(sce_control@int_colData@listData$altExps@listData$ADT@se@assays@data@listData$logcounts)
  atac.filt <- as.matrix(sce_control@int_colData@listData$altExps@listData$ATAC@se@assays@data@listData$logcounts)
  sel <- names(which(rowSums(atac.filt == 0) / ncol(atac.filt) < 0.99))
  atac.filt <- atac.filt[sel,]  
  cty <- factor(sce_control$celltype)
  
  ###########filter the cell type whose number is less than 10###########
  rna.filt <- rna.filt[, cty %in% names(table(cty))[table(cty)>10]]
  adt.filt <- adt.filt[, cty %in% names(table(cty))[table(cty)>10]]
  atac.filt <- atac.filt[, cty %in% names(table(cty))[table(cty)>10]]
  cty <- cty[cty %in% names(table(cty))[table(cty)>10]]
  cty <- as.character(cty)

  ################## z-score normalization ##################
  mean_rna <- colMeans(rna.filt)
  sd_rna <- colSds(rna.filt)
  mean_rna<-c(rep(mean_rna,dim(rna.filt)[1]))
  mean_rna <-t(matrix(mean_rna, nrow=dim(rna.filt)[2]))
  sd_rna<-c(rep(sd_rna,dim(rna.filt)[1]))
  sd_rna <-t(matrix(sd_rna, nrow=dim(rna.filt)[2]))
  rna.filt <- (rna.filt - mean_rna)/sd_rna
  
  mean_adt <- colMeans(adt.filt)
  sd_adt <- colSds(adt.filt)
  mean_adt<-c(rep(mean_adt,dim(adt.filt)[1]))
  mean_adt <-t(matrix(mean_adt, nrow=dim(adt.filt)[2]))
  sd_adt<-c(rep(sd_adt,dim(adt.filt)[1]))
  sd_adt <-t(matrix(sd_adt, nrow=dim(adt.filt)[2]))
  adt.filt <- (adt.filt - mean_adt)/sd_adt

  mean_atac <- colMeans(atac.filt)
  sd_atac <- colSds(atac.filt)
  mean_atac<-c(rep(mean_atac,dim(atac.filt)[1]))
  mean_atac <-t(matrix(mean_atac, nrow=dim(atac.filt)[2]))
  sd_atac<-c(rep(sd_atac,dim(atac.filt)[1]))
  sd_atac <-t(matrix(sd_atac, nrow=dim(atac.filt)[2]))
  atac.filt <- (atac.filt - mean_atac)/sd_atac
}  
```

## Load real datasets and process for CITE-seq data
```{r}
if (dataset_name == "Ramaswamy et al. (GSE166489)"){
  ###########  load rna and adt, then filt them to 99%  ###########
  sce_control <- readRDS("../data/Ramaswamy et al. (GSE166489)/batch1_rna.rds")
  sel <- names(which(rowSums(logcounts(sce_control) == 0) / ncol(logcounts(sce_control)) < 0.99))
  sce_control <- sce_control[sel,]
  rna.filt <- as.matrix(logcounts(sce_control))
  adt.filt <- readRDS("../data/Ramaswamy et al. (GSE166489)/batch1_adt.rds")
  adt.filt <- as.matrix(logcounts(adt.filt))
  cty <- factor(sce_control$celltype)

  ###########filter the cell type whose number is less than 10###########
  rna.filt <- rna.filt[, cty %in% names(table(cty))[table(cty)>10]]
  adt.filt <- adt.filt[, cty %in% names(table(cty))[table(cty)>10]]
  cty <- cty[cty %in% names(table(cty))[table(cty)>10]]
  cty <- as.character(cty)
  
  ################## z-score normalization ##################
  mean_rna <- colMeans(rna.filt)
  sd_rna <- colSds(rna.filt)
  mean_rna<-c(rep(mean_rna,dim(rna.filt)[1]))
  mean_rna <-t(matrix(mean_rna, nrow=dim(rna.filt)[2]))
  sd_rna<-c(rep(sd_rna,dim(rna.filt)[1]))
  sd_rna <-t(matrix(sd_rna, nrow=dim(rna.filt)[2]))
  rna.filt <- (rna.filt - mean_rna)/sd_rna
  
  mean_adt <- colMeans(adt.filt)
  sd_adt <- colSds(adt.filt)
  mean_adt<-c(rep(mean_adt,dim(adt.filt)[1]))
  mean_adt <-t(matrix(mean_adt, nrow=dim(adt.filt)[2]))
  sd_adt<-c(rep(sd_adt,dim(adt.filt)[1]))
  sd_adt <-t(matrix(sd_adt, nrow=dim(adt.filt)[2]))
  adt.filt <- (adt.filt - mean_adt)/sd_adt
}  
```



## 5 fold cross validation setting, we use one fold as train data, 4 folds as test data
```{r}
seed5fold_2modal <- function(rna.filt=rna.filt, adt.filt=adt.filt, cty=cty, seedInput=1234, fold = 1){
  set.seed(seedInput)
  f <- createFolds(cty, 5)
  
  rna.1 <- rna.filt[, f[[1]]]
  rna.2 <- rna.filt[, f[[2]]]
  rna.3 <- rna.filt[, f[[3]]]
  rna.4 <- rna.filt[, f[[4]]]
  rna.5 <- rna.filt[, f[[5]]]
  
  adt.1 <- adt.filt[, f[[1]]]
  adt.2 <- adt.filt[, f[[2]]]
  adt.3 <- adt.filt[, f[[3]]]
  adt.4 <- adt.filt[, f[[4]]]
  adt.5 <- adt.filt[, f[[5]]]
  
  folds.test <- list( c(f[[2]], f[[3]], f[[4]], f[[5]]),
                      c(f[[1]], f[[3]], f[[4]], f[[5]]),
                      c(f[[1]], f[[2]], f[[4]], f[[5]]),
                      c(f[[1]], f[[2]], f[[3]], f[[5]]),
                      c(f[[1]], f[[2]], f[[3]], f[[4]])
                      )

  folds.train <- list(c(f[[1]]),
                     c(f[[2]]),
                     c(f[[3]]),
                     c(f[[4]]),
                     c(f[[5]])
                     )
  
  train1.rna <- rna.filt[, folds.train[[fold]]]
  train1.adt <- adt.filt[, folds.train[[fold]]]
  train1.cty <- cty[folds.train[[fold]]]
  
  test1.rna <- rna.filt[, folds.test[[fold]]]
  test1.adt <- adt.filt[, folds.test[[fold]]]
  test1.cty <- cty[folds.test[[fold]]]

  return(list(train.rna = train1.rna, train.adt = train1.adt, train.cty = train1.cty, test.rna = test1.rna, test.adt = test1.adt, test.cty = test1.cty))
}

seed5fold_3modal <- function(rna.filt=rna.filt, adt.filt=adt.filt, atac.filt=atac.filt, cty=cty, seedInput=1234, fold = 1){
  set.seed(seedInput)
  f <- createFolds(cty, 5)
  
  rna.1 <- rna.filt[, f[[1]]]
  rna.2 <- rna.filt[, f[[2]]]
  rna.3 <- rna.filt[, f[[3]]]
  rna.4 <- rna.filt[, f[[4]]]
  rna.5 <- rna.filt[, f[[5]]]
  
  adt.1 <- adt.filt[, f[[1]]]
  adt.2 <- adt.filt[, f[[2]]]
  adt.3 <- adt.filt[, f[[3]]]
  adt.4 <- adt.filt[, f[[4]]]
  adt.5 <- adt.filt[, f[[5]]]
  
  atac.1 <- atac.filt[, f[[1]]]
  atac.2 <- atac.filt[, f[[2]]]
  atac.3 <- atac.filt[, f[[3]]]
  atac.4 <- atac.filt[, f[[4]]]
  atac.5 <- atac.filt[, f[[5]]]
  
  folds.test <- list( c(f[[2]], f[[3]], f[[4]], f[[5]]),
                      c(f[[1]], f[[3]], f[[4]], f[[5]]),
                      c(f[[1]], f[[2]], f[[4]], f[[5]]),
                      c(f[[1]], f[[2]], f[[3]], f[[5]]),
                      c(f[[1]], f[[2]], f[[3]], f[[4]])
                      )

  folds.train <- list(c(f[[1]]),
                     c(f[[2]]),
                     c(f[[3]]),
                     c(f[[4]]),
                     c(f[[5]])
                     )
  
  train1.rna <- rna.filt[, folds.train[[fold]]]
  train1.adt <- adt.filt[, folds.train[[fold]]]
  train1.atac <- atac.filt[, folds.train[[fold]]]
  train1.cty <- cty[folds.train[[fold]]]
  
  test1.rna <- rna.filt[, folds.test[[fold]]]
  test1.adt <- adt.filt[, folds.test[[fold]]]
  test1.atac <- atac.filt[, folds.test[[fold]]]
  test1.cty <- cty[folds.test[[fold]]]

  return(list(train.rna = train1.rna, train.adt = train1.adt, train.atac = train1.atac, train.cty = train1.cty, test.rna = test1.rna, test.adt = test1.adt, test.atac = test1.atac, test.cty = test1.cty))
}
```

##Saving data as h5 files
```{r}
for (seedInput in c(1)) {
  for (fold in c(1:5)){
    if (dataset_name == "Ma et al. (GSE140203)"){
      Res_5fold <- seed5fold_2modal(rna.filt, atac.filt, cty, seedInput,fold)
      train.rna <- Res_5fold$train.rna
      train.adt <- Res_5fold$train.adt
      train.cty <- Res_5fold$train.cty
      test.rna <- Res_5fold$test.rna
      test.adt <- Res_5fold$test.adt
      test.cty <- Res_5fold$test.cty
      write_h5_scJoint(exprs_list = list(rna = rbind(train.rna,train.adt)), 
                 h5file_list = c(glue("./../processed_data/{dataset_name}/train_seed{seedInput}_fold{fold}.h5")))
      write_h5_scJoint(exprs_list = list(rna = rbind(test.rna,test.adt)), 
                 h5file_list = c(glue("./../processed_data/{dataset_name}/test_seed{seedInput}_fold{fold}.h5")))
      write_csv_scJoint(cellType_list =  list(rna = train.cty),
                csv_list = c(glue("./../processed_data/{dataset_name}/train_seed{seedInput}_fold{fold}_cty.csv")))
      write_csv_scJoint(cellType_list =  list(rna = test.cty),
                csv_list = c(glue("./../processed_data/{dataset_name}/test_seed{seedInput}_fold{fold}_cty.csv")))      
    }
    
    if (dataset_name == "Ramaswamy et al. (GSE166489)"){
      Res_5fold <- seed5fold_2modal(rna.filt, adt.filt, cty, seedInput,fold)
      train.rna <- Res_5fold$train.rna
      train.adt <- Res_5fold$train.adt
      train.cty <- Res_5fold$train.cty
      test.rna <- Res_5fold$test.rna
      test.adt <- Res_5fold$test.adt
      test.cty <- Res_5fold$test.cty
      write_h5_scJoint(exprs_list = list(rna = rbind(train.rna,train.adt)), 
                 h5file_list = c(glue("./../processed_data/{dataset_name}/train_seed{seedInput}_fold{fold}.h5")))
      write_h5_scJoint(exprs_list = list(rna = rbind(test.rna,test.adt)), 
                 h5file_list = c(glue("./../processed_data/{dataset_name}/test_seed{seedInput}_fold{fold}.h5")))
      write_csv_scJoint(cellType_list =  list(rna = train.cty),
                csv_list = c(glue("./../processed_data/{dataset_name}/train_seed{seedInput}_fold{fold}_cty.csv")))
      write_csv_scJoint(cellType_list =  list(rna = test.cty),
                csv_list = c(glue("./../processed_data/{dataset_name}/test_seed{seedInput}_fold{fold}_cty.csv")))  
    }
    
    if (dataset_name == "Swanson et al. (GSE158013)"){
      Res_5fold <- seed5fold_3modal(rna.filt, adt.filt, atac.filt, cty, seedInput,fold)
      train.rna <- Res_5fold$train.rna
      train.adt <- Res_5fold$train.adt
      train.atac <- Res_5fold$train.atac
      train.cty <- Res_5fold$train.cty
      test.rna <- Res_5fold$test.rna
      test.adt <- Res_5fold$test.adt
      test.atac <- Res_5fold$test.atac
      test.cty <- Res_5fold$test.cty
    write_h5_scJoint(exprs_list = list(rna = rbind(train.rna,train.adt,train.atac)), 
               h5file_list = c(glue("./../processed_data/{dataset_name}/train_seed{seedInput}_fold{fold}.h5")))
    write_h5_scJoint(exprs_list = list(rna = rbind(test.rna,test.adt, test.atac)), 
               h5file_list = c(glue("./../processed_data/{dataset_name}/test_seed{seedInput}_fold{fold}.h5")))
      write_csv_scJoint(cellType_list =  list(rna = train.cty),
                csv_list = c(glue("./../processed_data/{dataset_name}/train_seed{seedInput}_fold{fold}_cty.csv")))
      write_csv_scJoint(cellType_list =  list(rna = test.cty),
                csv_list = c(glue("./../processed_data/{dataset_name}/test_seed{seedInput}_fold{fold}_cty.csv")))  
    }

  }
}
```

```{r}
sessionInfo()
```
